---
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, results = "hide", fig.show = FALSE)

# Author: Matthew Thompson

# File Name: [Weekly 3_Assignment4].R
# Date: 2025-02-07

# Description: Creates a plot that attempt to answer multiple questions in one complex plot

# Purpose: The objective is to answer two questions: 
#1) How has the seasonally adjusted HPI changed over time between regions of the US? 
#2) How has the non-seasonally adjusted HPI changed over time across regions of the US?

# Setting up the sourcing file directory
snippets_dir <- "/Users/matthewthompson/Documents/R Programming/Comprehensive Snippets/Functions"

# Source the R version functions
source(file.path(snippets_dir, "print_r_version.R"))

# Version:
print_r_version()

#Project Directory Overview:
source(file.path(snippets_dir, "project_directory_tree.R"))
project_directory_tree()

# Change Log:
#YYYY-MM-DD: Initial version

#===========================

# Packages and loaded (choose to source or manually install and load yourself)
source(file.path(snippets_dir, "install_data_science_packages.R"))

#manually install (if applicable) and load libraries below:
#type here for libraries and packages

# Install Addins (optional)
source(file.path(snippets_dir, "install_addins.R"))

#===============================================================================

########################
#Loading dataset(s) and other files 
########################

# Load the dataset using read.table()
# setyourdata_variablehere <- read.table( #customize read.table() settings below
# file = dataset_path,
# header = TRUE,            # Set to FALSE if the file has no header row
# sep = "\t",               # Change to ',' for CSV, '|' for pipe-delimited, etc.
# stringsAsFactors = FALSE, # Prevent automatic conversion of character columns to factors
# na.strings = c("NA", ""), # Specify how missing values are represented
# quote = "\"",             # Define how quoted strings are handled (e.g., single or double quotes)
# dec = ".",                # Decimal point (change to ',' for European-style decimals)
# comment.char = "#",       # Define the character for comment lines (set to '' to disable)
# check.names = TRUE        # Ensure column names are syntactically valid
# )

#OR source from other r script for either excel or csv 
source(file.path(snippets_dir, "load_excel_or_csv.R"))

#name the variable and set the path to where your desired file is (must be excel or csv)
housing_price <- load_excel_or_csv("Housing Price Index.xlsx - Data.csv")

#===============================================================================

```

```{r data cleaning, echo = FALSE, results= FALSE}

#Before proceeding, its worth knowing the question:
#How does the non-nonseasonally adjusted HPI change over 
#the course of the calendar year, and how has that changed over years. 

#Over the course of the calendar year, I think it means 
#how it change in the 12 months #from Jan to Dec for each year

#so, I need to show all months per year, but I think it might be 
#a bit overwhelming to read so much information

#I think my table could
#show a long format across years from early years to winter 
#four seasons to be specific (winter-fall starting in Jan)

#==============
#First things first, time to mutate columns for month, date, and year as well
housing_price2 <- housing_price %>%
mutate(Date = as.POSIXct(Date, format = "%m/%d/%Y")) %>% #had to adjust to match the format 
mutate(Year = year(Date)) %>%
mutate(Month = month(Date)) %>%
mutate(Day = day(Date)) 

#I need to verify NA values again
housing_price2_NA <- housing_price2 %>%
  group_by(Year) %>%
  filter(is.na(USA.SA.)) #No results so no NA

housing_price2_NSA_NA <- housing_price2 %>%
  group_by(Year) %>%
  filter(is.na(USA.NSA.)) #No results 

#Let's check for duplicates if possible, again
housing_price_dup <- housing_price2 %>%
  group_by(Date) %>%
  tally() %>%
  filter(n > 1) #no dupes for each date 

```

```{r data manipulation, echo = FALSE, results= FALSE}
###############
#Data Manipulations
###############

#Now I need to add month names and then merge 
mon <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December")
monthnames <- data.frame(Month = 1:12, longnames = mon)

monthnames1 <- monthnames %>%
mutate(longnames = factor(longnames, levels = mon))
#ensures correct alphabetical order in case instead of
#default alphabetical order

months_housingprices <- merge(housing_price2, monthnames, by = "Month", all = TRUE)
#merges months into the original data

#Now, I just need to filter the dataset to only show HPI.NSA since that's what we should be looking at 

HPI_NSA <- months_housingprices %>%
  dplyr::select("USA.NSA.", "Year", "longnames")

head(HPI_NSA)
  
#Renaming longnames to Month
HPI_NSA2 <- HPI_NSA %>%
  rename("Month" = "longnames")

#The dataset is now cleaned up with year, month, and US NSA only
#days are not necessary because they're all 1 so
#they're removed to make the further process easier

#I think I need to group months so I have to 
#mutate a new column that assigns season to each month

#I'll use meteorlogical definition of season
#when it starts so:
#meteorological spring in the Northern Hemisphere includes March, April, and May; 
#meteorological summer includes June, July, and August; 
#meteorological fall includes September, October, and November; 
#meteorological winter includes December, January, and February

Added_Seasons <- HPI_NSA2 %>%
  mutate(Season = case_when(
    Month %in% c("December", "January", "February") ~ "Winter",
    Month %in% c("March", "April", "May") ~ "Spring",
    Month %in% c("June", "July", "August") ~ "Summer",
    Month %in% c("September", "October", "November") ~ "Fall")
  )

#Now, I have months assigned to season so 
#let's see if I can summarize mean across seasons for each year
Mean_HPI <- Added_Seasons %>%
  group_by(Year, Season) %>%
  summarize(Overall.HPI = mean(USA.NSA., na.rm = TRUE), .groups = 'drop')

Mean_HPI_wide <- dcast(Mean_HPI, Year ~ Season, value.var = "Overall.HPI")
#Oh this table is perfect, this is what I want to show 

Mean_HPI_wide <- round(Mean_HPI_wide, digits = 1)
#rounding up to tenths will help reduce space taken

#I think it'll be nice to show average US over the years 
#so it adds to how HPI really changed over time (in years)

Final_HPI <- Mean_HPI_wide %>%
  mutate(Yearly.HPI = rowMeans(dplyr::select(., -Year), na.rm = TRUE))

Final_HPI <- round(Final_HPI, digits = 1)

Final_HPI <- Final_HPI %>%
  rename("Yearly HPI" = "Yearly.HPI")

```

```{r making table, echo = FALSE, results='hide'}

############
#Making Table
############

#set as data frame to avoid potential issues with grouping variables and gt()
Final_HPI <- as.data.frame(Final_HPI)

Final_HPI2 <- Final_HPI %>% 
  gt(rowname_col = "Year", auto_align = FALSE)  
#groups rows by year in case

#making a table
Final_HPI_Output <- Final_HPI %>%
  gt() %>%
  tab_spanner( #making a tab spanner label for time and average HPI across time
    label = "Time",
    columns = "Year"
  ) %>%
  tab_spanner(
    label = "Average HPI Across Time",
    columns = c("Winter", "Spring", "Summer", "Fall", "Yearly HPI")  
  ) %>%
  tab_style(style = cell_borders(sides = "bottom", color = "grey"), 
            #stylizing rows for better readability
            locations = cells_body()) %>%
  tab_style(style = cell_fill(color = "#89CFF0"),
            locations = cells_body(rows = seq(1, 34, 2))
  ) %>%
  tab_style(style = cell_fill(color = "#F0FFFF"),
            locations = cells_body(rows = seq(2, 35, 2))
  ) %>%
  #adding colors to alternating rows 
  cols_align(
    align = "left",
    columns = "Year"
  ) %>%
  cols_align(
    align = "center",
    columns = c("Winter", "Spring", "Summer", "Fall")
  ) %>%
  cols_align(
    align = "right",
    columns = "Yearly HPI"
  ) %>%
  opt_table_outline(style = "solid", width = px(1), color = "gray")
  #aligns texts to make table look nicer
 
Final_HPI_Output

```

```{r show table, echo = FALSE, results = 'show', fig.align='center', }
gtsave(Final_HPI_Output, "table.html") 
webshot2::webshot("table.html", file = "FinalHPITime.png", 
                  zoom = 3)   
```

**Table 1.** HPIs across months were averaged into each season across years and rounded up (to tenths) to avoid overwhelming loads of numbers. Yearly HPI was the average of HPIs across months for each year showing the yearly trend. HPI continued to increase since 1991 until 2008 when it started to drop. Then, it started increasing again in 2011. By 2021, HPI increased more sharply, then likely increased more moderately by 2023. Across months, Summer and Fall were consistent with the highest HPI compared to Winter and Spring. The only time this trend was inconsistent was during the HPI decline (2008-2011). Thus, every other years where HPI was on the raise were consistent with Summer and Fall as having the highest HPI per year. 

\newpage

## R Script

```{r data cleaning final, echo = TRUE, results= FALSE}

############
#File Description:
#Author: Matthew Thompson
#Date: February 13, 2025
#Title: Assignment 4

#Prompt Question: How does the non-seasonally adjusted HPI change 
#over the course of the calendar year, 
#and how has that changed over the years?

#====================
#Exporting Dataset
#====================

housing_price <- read_csv("Housing Price Index.xlsx - Data.csv")

###########
#Data Cleaning
###########

#Before proceeding, its worth knowing the question:
#How does the non-nonseasonally adjusted HPI change over 
#the course of the calendar year, and how has that changed over years. 

#Over the course of the calendar year, I think it means 
#how it change in the 12 months #from Jan to Dec for each year

#so, I need to show all months per year, but I think it might be 
#a bit overwhelming to read so much information

#I think my table could
#show a long format across years from early years to winter 
#four seasons to be specific (winter-fall starting in Jan)

#==============

#First things first, time to mutate columns for month, date, and year as well
housing_price2 <- housing_price %>%
mutate(Date = as.POSIXct(Date, format = "%m/%d/%Y")) %>% 
  #had to adjust to match the format 
mutate(Year = year(Date)) %>%
mutate(Month = month(Date)) %>%
mutate(Day = day(Date)) 

#I need to verify NA values again
housing_price2_NA <- housing_price2 %>%
  group_by(Year) %>%
  filter(is.na("USA(NSA)")) #No results so no NA

housing_price2_NSA_NA <- housing_price2 %>%
  group_by(Year) %>%
  filter(is.na("USA(NSA)")) #No results 

#Let's check for duplicates if possible, again
housing_price_dup <- housing_price2 %>%
  group_by(Date) %>%
  tally() %>%
  filter(n > 1) #no dupes for each date 

```
\newpage
```{r data manipulation final, echo = TRUE, results= FALSE}

###############
#Data Manipulations
###############

#Now I need to add month names and then merge 
mon <- c("January", "February", "March", 
         "April", "May", "June", 
         "July", "August", "September", 
         "October", "November", "December")
monthnames <- data.frame(Month = 1:12, longnames = mon)

monthnames1 <- monthnames %>%
mutate(longnames = factor(longnames, levels = mon))
#ensures correct alphabetical order in case instead of
#default alphabetical order

months_housingprices <- merge(housing_price2, monthnames, by = "Month", all = TRUE)
#merges months into the original data

#Now, I just need to filter the dataset to only show HPI(NSA) 
#since that's what we should be looking at 

HPI_NSA <- months_housingprices %>%
  dplyr::select("USA(NSA)", "Year", "longnames")

head(HPI_NSA)
  
#Renaming longnames to Month
HPI_NSA2 <- HPI_NSA %>%
  rename("Month" = "longnames")

#The dataset is now cleaned up with year, month, and US NSA only
#days are not necessary because they're all 1 so
#they're removed to make the further process easier

#I think I need to group months so I have to 
#mutate a new column that assigns season to each month

#I'll use meteorlogical definition of season
#when it starts so:
#meteorological spring in the Northern Hemisphere includes March, April, and May; 
#meteorological summer includes June, July, and August; 
#meteorological fall includes September, October, and November; 
#meteorological winter includes December, January, and February

Added_Seasons <- HPI_NSA2 %>%
  mutate(Season = case_when(
    Month %in% c("December", "January", "February") ~ "Winter",
    Month %in% c("March", "April", "May") ~ "Spring",
    Month %in% c("June", "July", "August") ~ "Summer",
    Month %in% c("September", "October", "November") ~ "Fall")
  )

#Now, I have months assigned to season so 
#let's see if I can summarize mean across seasons for each year
Mean_HPI <- Added_Seasons %>%
  group_by(Year, Season) %>%
  summarize(Overall.HPI = mean("USA(NSA)", na.rm = TRUE), .groups = 'drop')

Mean_HPI_wide <- dcast(Mean_HPI, Year ~ Season, value.var = "Overall.HPI")
#Oh this table is perfect, this is what I want to show 

Mean_HPI_wide <- round(Mean_HPI_wide, digits = 1)
#rounding up to tenths will help reduce space taken

#I think it'll be nice to show average US over the years 
#so it adds to how HPI really changed over time (in years)

Final_HPI <- Mean_HPI_wide %>%
  mutate(Yearly.HPI = rowMeans(dplyr::select(., -Year), na.rm = TRUE))

Final_HPI <- round(Final_HPI, digits = 1)

Final_HPI <- Final_HPI %>%
  rename("Yearly HPI" = "Yearly.HPI")

```
\newpage
```{r making table final, echo = TRUE, results='hide'}

############
#Making Table
############

#set as data frame to avoid potential issues with grouping variables and gt()
Final_HPI <- as.data.frame(Final_HPI)

Final_HPI2 <- Final_HPI %>% 
  gt(rowname_col = "Year", auto_align = FALSE)  
#groups rows by year in case

#making a table
Final_HPI_Output <- Final_HPI %>%
  gt() %>%
  tab_spanner( #making a tab spanner label for time and average HPI across time
    label = "Time",
    columns = "Year"
  ) %>%
  tab_spanner(
    label = "Average HPI Across Time",
    columns = c("Winter", "Spring", "Summer", "Fall", "Yearly HPI")  
  ) %>%
  tab_style(style = cell_borders(sides = "bottom", color = "grey"), 
            #stylizing rows for better readability
            locations = cells_body()) %>%
  tab_style(style = cell_fill(color = "#89CFF0"),
            locations = cells_body(rows = seq(1, 34, 2))
  ) %>%
  tab_style(style = cell_fill(color = "#F0FFFF"),
            locations = cells_body(rows = seq(2, 35, 2))
  ) %>%
  #adding colors to alternating rows 
  cols_align(
    align = "left",
    columns = "Year"
  ) %>%
  cols_align(
    align = "center",
    columns = c("Winter", "Spring", "Summer", "Fall")
  ) %>%
  cols_align(
    align = "right",
    columns = "Yearly HPI"
  ) %>%
  opt_table_outline(style = "solid", width = px(1), color = "gray")
  #aligns texts to make table look nicer
 
Final_HPI_Output

```
\newpage
```{r show table final, echo = TRUE, results = 'hide'}
##########
#Exporting Table (Render Properly in PDF)
##########

#gtsave(Final_HPI_Output, "table.html") 
#webshot2::webshot("table.html", file = "FinalHPITime.png", 
#                  zoom = 3)   

#Uncomment to run since in the rscript, results still showed 
#even with result= 'hide'

```
